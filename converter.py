import subprocess
import re
import os

def run_jumanpp(sentence):
    """
    è¿è¡Œ jumanpp å½¢æ€åˆ†æå™¨ï¼Œè·å–åˆ†æç»“æœã€‚
    """
    # è¯·æ ¹æ®æ‚¨çš„ç¯å¢ƒè®¾ç½® jumanpp å¯æ‰§è¡Œæ–‡ä»¶å’Œæ¨¡å‹çš„è·¯å¾„
    jumanpp_exe = r"E:\jumanpp-2.0.0-rc4\build\src\jumandic\Release\jumanpp_v2.exe"
    model_path = r"E:\jumanpp-2.0.0-rc4\model\jumandic.jppmdl"
    command = [jumanpp_exe, '--model', model_path]

    process = subprocess.Popen(command, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, encoding='utf-8')
    stdout, stderr = process.communicate(sentence)
    if stderr:
        print("Error:", stderr)
    return stdout

def parse_jumanpp_output(output):
    """
    è§£æ jumanpp çš„è¾“å‡ºï¼Œæå–æ¯ä¸ªå•è¯çš„è¡¨å±‚å½¢å¼å’Œå‡åè¯»éŸ³ã€‚
    """
    words = []
    current_word = None
    for line in output.strip().split('\n'):
        if line.strip() == 'EOS':
            break
        if line.startswith('@'):
            # å¤„ç†æœ‰å¤šä¸ªå¯èƒ½è§£æçš„æƒ…å†µï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
            continue
        else:
            fields = line.split()
            if len(fields) < 2:
                continue
            surface = fields[0]
            reading = fields[1]
            words.append({'surface': surface, 'reading': reading})
    return words

def kana_to_ipa(kana):
    """
    å°†å‡åè¯»éŸ³è½¬æ¢ä¸º IPA è¡¨ç¤ºï¼Œéµå¾ªç‰¹å®šçš„éŸ³éŸµè§„åˆ™ã€‚
    """
    # ä½¿ç”¨æ‚¨æä¾›çš„æ–°çš„ kana_to_ipa_map
    kana_to_ipa_map = {
        # å…ƒéŸ³
        'ã‚': 'Ã¤',  'ã„': 'i',   'ã†': 'É¯Ì¹',  'ãˆ': 'eÌ',  'ãŠ': 'oÌ',
        'ã‚¢': 'a',  'ã‚¤': 'i',   'ã‚¦': 'É¯Ì¹',  'ã‚¨': 'eÌ',  'ã‚ª': 'oÌ',
        
        # æ¸…éŸ³è¾…éŸ³è¡Œ
        'ã‹': 'kÃ¤', 'ã': 'kÊ²i', 'ã': 'kÉ¯Ì¹', 'ã‘': 'keÌ', 'ã“': 'koÌ',
        'ã‚«': 'kÃ¤', 'ã‚­': 'kÊ²i', 'ã‚¯': 'kÉ¯Ì¹', 'ã‚±': 'keÌ', 'ã‚³': 'koÌ',
        
        'ã•': 'sÃ¤', 'ã—': 'É•i', 'ã™': 'sÉ¯Ì¹Ìˆ', 'ã›': 'seÌ', 'ã': 'soÌ',
        'ã‚µ': 'sÃ¤', 'ã‚·': 'É•i', 'ã‚¹': 'sÉ¯Ì¹Ìˆ', 'ã‚»': 'seÌ', 'ã‚½': 'soÌ',
        
        'ãŸ': 'tÃ¤', 'ã¡': 'tÍ¡É•Ê²iÌ', 'ã¤': 'tÍ¡sÉ¯Ì¹Ìˆ', 'ã¦': 'teÌ', 'ã¨': 'toÌ',
        'ã‚¿': 'tÃ¤', 'ãƒ': 'tÍ¡É•Ê²iÌ', 'ãƒ„': 'tÍ¡sÉ¯Ì¹Ìˆ', 'ãƒ†': 'teÌ', 'ãƒˆ': 'toÌ',
        
        'ãª': 'nÃ¤', 'ã«': 'nÊ²i', 'ã¬': 'nÉ¯Ì¹', 'ã­': 'neÌ', 'ã®': 'noÌ',
        'ãƒŠ': 'nÃ¤', 'ãƒ‹': 'nÊ²i', 'ãƒŒ': 'nÉ¯Ì¹', 'ãƒ': 'neÌ', 'ãƒ': 'noÌ',
        
        'ã¯': 'hÃ¤', 'ã²': 'Ã§Ê²i', 'ãµ': 'É¸É¯Ì¹Ì½', 'ã¸': 'heÌ', 'ã»': 'hoÌ',
        'ãƒ': 'hÃ¤', 'ãƒ’': 'Ã§Ê²i', 'ãƒ•': 'É¸É¯Ì¹Ì½', 'ãƒ˜': 'heÌ', 'ãƒ›': 'hoÌ',
        
        'ã¾': 'mÃ¤', 'ã¿': 'mÊ²i',  'ã‚€': 'mÉ¯Ì¹', 'ã‚': 'meÌ', 'ã‚‚': 'moÌ',
        'ãƒ': 'mÃ¤', 'ãƒŸ': 'mÊ²i',  'ãƒ ': 'mÉ¯Ì¹', 'ãƒ¡': 'meÌ', 'ãƒ¢': 'moÌ',
        
        'ã‚„': 'jÃ¤', 'ã‚†': 'jÉ¯Ì¹', 'ã‚ˆ': 'joÌ', 'ğ›€': 'jeÌ',
        'ãƒ¤': 'jÃ¤', 'ãƒ¦': 'jÉ¯Ì¹', 'ãƒ¨': 'joÌ',
        
        'ã‚‰': 'ÉºÃ¤', 'ã‚Š': 'ÉºÊ²i',  'ã‚‹': 'ÉºÉ¯Ì¹', 'ã‚Œ': 'ÉºeÌ', 'ã‚': 'ÉºoÌ',
        'ãƒ©': 'ÉºÃ¤', 'ãƒª': 'ÉºÊ²i',  'ãƒ«': 'ÉºÉ¯Ì¹', 'ãƒ¬': 'ÉºeÌ', 'ãƒ­': 'ÉºoÌ',
        
        'ã‚': 'Î²ÌÃ¤', 'ã‚': 'i', 'ã‚‘': 'eÌ',  'ã‚’': 'oÌ',
        'ãƒ¯': 'Î²ÌÃ¤', 'ãƒ°': 'i', 'ãƒ±': 'eÌ',  'ãƒ²': 'oÌ',
        
        'ã‚“': 'É´',  'ã£': 'Ìš',
        'ãƒ³': 'É´',  'ãƒƒ': 'Ìš',
        
        # æµŠéŸ³è¾…éŸ³è¡Œ
        'ãŒ': 'É¡Ã¤', 'ã': 'É¡Ê²iÌ',  'ã': 'É¡É¯Ì¹Ë•', 'ã’': 'É¡eÌ', 'ã”': 'É¡oÌœ',
        'ã‚¬': 'É¡Ã¤', 'ã‚®': 'É¡Ê²iÌ',  'ã‚°': 'É¡É¯Ì¹Ë•', 'ã‚²': 'É¡eÌ', 'ã‚´': 'É¡oÌœ',
        
        'ã–': 'zÃ¤', 'ã˜': 'dÍ¡Ê‘iÌ',  'ãš': 'zÉ¯Ì¹Ë•', 'ãœ': 'zeÌ', 'ã': 'zoÌœ',
        'ã‚¶': 'zÃ¤', 'ã‚¸': 'dÍ¡Ê‘iÌ',  'ã‚º': 'zÉ¯Ì¹Ë•', 'ã‚¼': 'zeÌ', 'ã‚¾': 'zoÌœ',
        
        'ã ': 'dÃ¤', 'ã¢': 'dÍ¡Ê‘iÌ',  'ã¥': 'dÍ¡zÉ¯áµ', 'ã§': 'deÌ', 'ã©': 'doÌœ',
        'ãƒ€': 'dÃ¤', 'ãƒ‚': 'dÍ¡Ê‘iÌ',  'ãƒ…': 'dÍ¡zÉ¯áµ', 'ãƒ‡': 'deÌ', 'ãƒ‰': 'doÌœ',
        
        'ã°': 'bÃ¤', 'ã³': 'bÊ²iÌ',  'ã¶': 'bÉ¯Ì¹Ë•', 'ã¹': 'beÌ', 'ã¼': 'boÌœ',
        'ãƒ': 'bÃ¤', 'ãƒ“': 'bÊ²iÌ',  'ãƒ–': 'bÉ¯Ì¹Ë•', 'ãƒ™': 'beÌ', 'ãƒœ': 'boÌœ',
        
        'ã±': 'pÃ¤', 'ã´': 'pÊ²iÌ',  'ã·': 'pÉ¯Ì¹Ë•', 'ãº': 'peÌ', 'ã½': 'poÌœ',
        'ãƒ‘': 'pÃ¤', 'ãƒ”': 'pÊ²iÌ',  'ãƒ—': 'pÉ¯Ì¹Ë•', 'ãƒš': 'peÌ', 'ãƒ': 'poÌœ',
        
        # æ‹—éŸ³
        'ãã‚ƒ': 'kÊ²aÌ ', 'ãã‚…': 'kÊ²É¨', 'ãã‚‡': 'kÊ²oÌ',
        'ãã‚ƒ': 'É¡Ê²aÌ ', 'ãã‚…': 'É¡Ê²É¨', 'ãã‚‡': 'É¡Ê²oÌ',
        'ã—ã‚ƒ': 'É•aÌ ', 'ã—ã‚…': 'É•É¯Ì¹', 'ã—ã‚‡': 'É•oÌ',
        'ã˜ã‚ƒ': 'dÍ¡Ê‘aÌ ', 'ã˜ã‚…': 'dÍ¡Ê‘É¨', 'ã˜ã‚‡': 'dÍ¡Ê‘oÌ',
        'ã¡ã‚ƒ': 'tÍ¡É•aÌ ', 'ã¡ã‚…': 'tÍ¡É•É¨', 'ã¡ã‚‡': 'tÍ¡É•oÌ',
        'ã«ã‚ƒ': 'É²ÌŸaÌ ', 'ã«ã‚…': 'É²ÌŸÉ¨', 'ã«ã‚‡': 'É²ÌŸoÌ',
        'ã²ã‚ƒ': 'Ã§aÌ ', 'ã²ã‚…': 'Ã§É¨', 'ã²ã‚‡': 'Ã§oÌ',
        'ã¿ã‚ƒ': 'mÊ²aÌ ', 'ã¿ã‚…': 'mÊ²É¨', 'ã¿ã‚‡': 'mÊ²oÌ',
        'ã‚Šã‚ƒ': 'É¾Ê²aÌ ', 'ã‚Šã‚…': 'É¾Ê²É¨', 'ã‚Šã‚‡': 'É¾Ê²oÌ',
        'ã³ã‚ƒ': 'bÊ²aÌ ', 'ã³ã‚…': 'bÊ²É¨', 'ã³ã‚‡': 'bÊ²oÌ',
        'ã´ã‚ƒ': 'pÊ²aÌ ', 'ã´ã‚…': 'pÊ²É¨', 'ã´ã‚‡': 'pÊ²oÌ',
        'ã¢ã‚ƒ': 'dÍ¡Ê‘aÌ ', 'ã¢ã‚…': 'dÍ¡Ê‘É¨', 'ã¢ã‚‡': 'dÍ¡Ê‘oÌ',
        'ã¥ã‚ƒ': 'dÍ¡zÊ²aÌ ', 'ã¥ã‚…': 'dÍ¡zÊ²É¨', 'ã¥ã‚‡': 'dÍ¡zÊ²oÌ',
        'ã‚­ãƒ£': 'kÊ²aÌ ', 'ã‚­ãƒ¥': 'kÊ²É¨', 'ã‚­ãƒ§': 'kÊ²oÌ',
        'ã‚®ãƒ£': 'É¡Ê²aÌ ', 'ã‚®ãƒ¥': 'É¡Ê²É¨', 'ã‚®ãƒ§': 'É¡Ê²oÌ',
        'ã‚·ãƒ£': 'É•aÌ ', 'ã‚·ãƒ¥': 'É•É¨', 'ã‚·ãƒ§': 'É•oÌ',
        'ã‚¸ãƒ£': 'dÍ¡Ê‘aÌ ', 'ã‚¸ãƒ¥': 'dÍ¡Ê‘É¨', 'ã‚¸ãƒ§': 'dÍ¡Ê‘oÌ',
        'ãƒãƒ£': 'tÍ¡É•aÌ ', 'ãƒãƒ¥': 'tÍ¡É•É¨', 'ãƒãƒ§': 'tÍ¡É•oÌ',
        'ãƒ‹ãƒ£': 'É²ÌŸaÌ ', 'ãƒ‹ãƒ¥': 'É²ÌŸÉ¨', 'ãƒ‹ãƒ§': 'É²ÌŸoÌ',
        'ãƒ’ãƒ£': 'Ã§aÌ ', 'ãƒ’ãƒ¥': 'Ã§É¨', 'ãƒ’ãƒ§': 'Ã§oÌ',
        'ãƒŸãƒ£': 'mÊ²aÌ ', 'ãƒŸãƒ¥': 'mÊ²É¨', 'ãƒŸãƒ§': 'mÊ²oÌ',
        'ãƒªãƒ£': 'É¾Ê²aÌ ', 'ãƒªãƒ¥': 'É¾Ê²É¨', 'ãƒªãƒ§': 'É¾Ê²oÌ',
        'ãƒ“ãƒ£': 'bÊ²aÌ ', 'ãƒ“ãƒ¥': 'bÊ²É¨', 'ãƒ“ãƒ§': 'bÊ²oÌ',
        'ãƒ”ãƒ£': 'pÊ²aÌ ', 'ãƒ”ãƒ¥': 'pÊ²É¨', 'ãƒ”ãƒ§': 'pÊ²oÌ',
        'ãƒ‚ãƒ£': 'dÍ¡Ê‘aÌ ', 'ãƒ‚ãƒ¥': 'dÍ¡Ê‘É¨', 'ãƒ‚ãƒ§': 'dÍ¡Ê‘oÌ',
        'ãƒ…ãƒ£': 'dÍ¡zÊ²aÌ ', 'ãƒ…ãƒ¥': 'dÍ¡zÊ²É¨', 'ãƒ…ãƒ§': 'dÍ¡zÊ²oÌ',
        
        # å¤–æ¥è¯­ç‰¹æ®Šæ‹—éŸ³
        'ãƒ•ã‚¡': 'É¸aÌ ', 'ãƒ•ã‚£': 'É¸Ê²i', 'ãƒ•ã‚§': 'É¸eÌ', 'ãƒ•ã‚©': 'É¸oÌ',
        'ãƒ†ã‚£': 'tÊ²i',  'ãƒ‡ã‚£': 'dÊ²i',  'ãƒã‚§': 'tÍ¡É•eÌ', 'ã‚·ã‚§': 'É•eÌ',
        'ã‚¸ã‚§': 'dÍ¡Ê‘eÌ', 'ãƒ„ã‚¡': 'tÍ¡saÌ ', 'ãƒ„ã‚£': 'tÍ¡sÊ²i', 'ãƒ„ã‚§': 'tÍ¡seÌ', 'ãƒ„ã‚©': 'tÍ¡soÌ',
        'ã‚¦ã‚£': 'Î²Ìi',  'ã‚¦ã‚§': 'Î²ÌeÌ',  'ã‚¦ã‚©': 'Î²ÌoÌ',
        'ã‚¯ã‚¡': 'káµaÌ ', 'ã‚°ã‚¡': 'É¡áµaÌ ',
        'ãã‡': 'kÊ²eÌ', 'ã—ã‡': 'É•eÌ', 'ã¡ã‡': 'tÍ¡É•Ê²eÌ',
        'ã«ã‡': 'É²ÌŸeÌ', 'ã²ã‡': 'Ã§eÌ', 'ã¿ã‡': 'mÊ²eÌ', 'ã‚Šã‡': 'É¾Ê²eÌ',
        'ãã‡': 'É¡Ê²eÌ', 'ã˜ã‡': 'dÍ¡Ê‘eÌ', 'ã³ã‡': 'bÊ²eÌ', 'ã´ã‡': 'pÊ²eÌ',
        'ãµã': 'É¸aÌ ', 'ãµãƒ': 'É¸Ê²i', 'ãµã‡': 'É¸eÌ', 'ãµã‰': 'É¸oÌ',
        'ã¦ãƒ': 'tÊ²i', 'ã§ãƒ': 'dÊ²i', 'ã¨ã…': 'tÉ¯ÌŸ', 'ã©ã…': 'dÉ¯ÌŸ',
        'ã†ãƒ': 'Î²Ìi', 'ã†ã‡': 'Î²ÌeÌ', 'ã†ã‰': 'Î²ÌoÌ',
        'ãƒ´ã‚¡': 'vaÌ ', 'ãƒ´ã‚£': 'vÊ²i', 'ãƒ´': 'vÉ¯ÌŸáµ', 'ãƒ´ã‚§': 'veÌ', 'ãƒ´ã‚©': 'voÌ',
        'ãƒ´ãƒ£': 'vÊ²aÌ ', 'ãƒ´ãƒ¥': 'vÊ²É¨', 'ãƒ´ãƒ§': 'vÊ²oÌ',
        
        # é•¿éŸ³
        'ãƒ¼': 'Ë',
        
        # å°å†™å‡å
        'ã': 'Ã¤', 'ãƒ': 'i', 'ã…': 'É¯Ì¹', 'ã‡': 'eÌ', 'ã‰': 'oÌ',
        'ã‚ƒ': 'aÌ ', 'ã‚…': 'É¨', 'ã‚‡': 'oÌ', 'ã‚': 'waÌ ',
        'ã‚¡': 'Ã¤', 'ã‚£': 'i', 'ã‚¥': 'É¯Ì¹', 'ã‚§': 'eÌ', 'ã‚©': 'oÌ',
        'ãƒ£': 'aÌ ', 'ãƒ¥': 'É¨', 'ãƒ§': 'oÌ', 'ãƒ®': 'waÌ ',
        'ã‚•': 'kaÌ ', 'ã‚–': 'keÌ',
        'ãƒµ': 'kaÌ ', 'ãƒ¶': 'keÌ',
    }

    # ä¸ºäº†å¤„ç†æ‹—éŸ³ï¼Œéœ€è¦å…ˆæŒ‰é•¿åº¦æ’åºé”®ï¼Œä»¥ç¡®ä¿å¤šå­—ç¬¦çš„å‡åä¼˜å…ˆåŒ¹é…
    kana_keys = sorted(kana_to_ipa_map.keys(), key=lambda x: -len(x))

    # å¤„ç†å‡åå­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸º IPA
    ipa = ''
    i = 0
    while i < len(kana):
        matched = False
        for kana_char in kana_keys:
            if kana.startswith(kana_char, i):
                ipa += kana_to_ipa_map[kana_char]
                i += len(kana_char)
                matched = True
                break
        if not matched:
            # æœªçŸ¥å­—ç¬¦ï¼Œè·³è¿‡æˆ–å¤„ç†
            i += 1
    return ipa

def handle_vowel_lengthening(ipa):
    """
    å¤„ç†å…ƒéŸ³é•¿éŸ³
    """
    # å¤„ç†é•¿éŸ³ç¬¦å· 'Ë'
    # å°†å…ƒéŸ³åæ¥ 'Ë' çš„æƒ…å†µåˆå¹¶ä¸ºé•¿å…ƒéŸ³
    ipa = re.sub(r'(Ã¤|i|É¯Ì¹|eÌ|oÌ)Ë', r'\1Ë', ipa)
    return ipa

def apply_phonological_rules(ipa):
    """
    åº”ç”¨éŸ³éŸµè§„åˆ™ï¼Œå¤„ç†æ¸…éŸ³åŒ–ã€é¼»éŸ³åŒ–ç­‰ã€‚
    """
    ipa = handle_vowel_lengthening(ipa)

    # 1. å¤„ç†ä¿ƒéŸ³ï¼ˆä½¿ç”¨ç‰¹æ®Šç¬¦å· 'Ìš' è¡¨ç¤ºï¼‰
    # å°†ä¿ƒéŸ³ç¬¦å· 'Ìš' æ›¿æ¢ä¸ºåç»­è¾…éŸ³çš„ä¿ƒéŸ³åŒ–
    # ç ´è£‚éŸ³å‰ä¸ºå†…ç ´éŸ³ï¼Œç ´æ“¦éŸ³å‰ä¸º [tÌš]ï¼Œæ‘©æ“¦éŸ³å‰è¾…éŸ³å»¶é•¿
    ipa = re.sub(r'Ìš([ptk])', r'\1Ìš\1', ipa)  # å†…ç ´éŸ³åŠ è¾…éŸ³é‡å¤
    ipa = re.sub(r'Ìš([tdz])', r'tÌš\1', ipa)    # ç ´æ“¦éŸ³å‰ä¸º [tÌš]
    ipa = re.sub(r'Ìš([sÊƒÉ•Ã§hÉ¸])', lambda m: m.group(1) * 2, ipa)  # æ‘©æ“¦éŸ³å‰è¾…éŸ³å»¶é•¿

    # 2. å¤„ç†æ‹¨éŸ³ 'É´' çš„åŒåŒ–
    # åŒå”‡éŸ³å‰çš„ 'É´' åŒåŒ–ä¸º [m]
    ipa = re.sub(r'É´([pbmÎ²ÌÉ¸])', r'm\1', ipa)
    # é½¿é¾ˆéŸ³å‰çš„ 'É´' åŒåŒ–ä¸º [n]
    ipa = re.sub(r'É´([tdnÉ¾szÊ‘É•])', r'n\1', ipa)
    # è½¯è…­éŸ³å‰çš„ 'É´' åŒåŒ–ä¸º [Å‹]
    ipa = re.sub(r'É´([kgÉ¡É£])', r'Å‹\1', ipa)
    # é¼»éŸ³å‰çš„å…ƒéŸ³é¼»åŒ–
    ipa = re.sub(r'([Ã¤iÉ¯Ì¹eÌoÌ])([mnÉ²Å‹É´])', r'\1Ìƒ\2', ipa)
    ipa = re.sub(r'([mnÉ²Å‹É´])([Ã¤iÉ¯Ì¹eÌoÌ])', r'\1\2Ìƒ', ipa)
    # åœ¨å…ƒéŸ³å’ŒåŠå…ƒéŸ³å‰ï¼Œ'É´' ä½¿åç»­å…ƒéŸ³é¼»åŒ–
    ipa = re.sub(r'É´([jÃ¤jÉ¯Ì¹joÌÃ¤ÉªÌŸeÌoÌ])', lambda m: m.group(1) + 'Ìƒ', ipa)
    # è¯å°¾çš„ 'É´' ä¿æŒä¸º [É´]
    ipa = re.sub(r'É´$', r'É´', ipa)

    # 3. å¤„ç†å…ƒéŸ³çš„æ¸…éŸ³åŒ–ï¼ˆä¸»è¦é’ˆå¯¹ [i] å’Œ [É¯Ì¹]ï¼‰
    # åœ¨æ— å£°è¾…éŸ³ä¹‹é—´æˆ–åœ¨æ— å£°è¾…éŸ³åè¯å°¾çš„ [i] å’Œ [É¯Ì¹] æ¸…éŸ³åŒ–
    ipa = re.sub(r'([ksthpÉ•Ã§É¸])([iÉ¯Ì¹])([ksthpÉ•Ã§É¸])', lambda m: m.group(1) + m.group(2) + 'Ì¥' + m.group(3), ipa)
    ipa = re.sub(r'([ksthpÉ•Ã§É¸])([iÉ¯Ì¹])$', lambda m: m.group(1) + m.group(2) + 'Ì¥', ipa)
    # å¢åŠ å¯¹ [oÌ] çš„æ¸…åŒ–å¤„ç†ï¼ˆå½“ç›¸é‚»ä¸¤ä¸ªä»¥ä¸Šçš„ [oÌ] æ—¶ï¼‰
    ipa = re.sub(r'(oÌ)(oÌ)+', lambda m: ''.join([c + 'Ì¥' for c in m.group(0)]), ipa)

    # 4. å¤„ç†æµŠè¾…éŸ³çš„å¼±åŒ–
    # åœ¨å…ƒéŸ³ä¹‹é—´çš„ [É¡] å¼±åŒ–ä¸º [É£]
    ipa = re.sub(r'([Ã¤iÉ¯Ì¹eÌoÌ])É¡([Ã¤iÉ¯Ì¹eÌoÌ])', r'\1É£\2', ipa)
    # åœ¨å…ƒéŸ³ä¹‹é—´çš„ [b] å¼±åŒ–ä¸º [Î²]'
    ipa = re.sub(r'([Ã¤iÉ¯Ì¹eÌoÌ])b([Ã¤iÉ¯Ì¹eÌoÌ])', r'\1Î²\2', ipa)

    # 5. å¤„ç†è¾…éŸ³çš„é¢šåŒ–
    # åœ¨ [i] æˆ– [j] å‰çš„è¾…éŸ³å¼ºé¢šåŒ–ï¼ŒåŠ ä¸Š Ê²
    ipa = re.sub(r'([tdn])([iÉªÌŸj])', lambda m: m.group(1) + 'Ê²' + m.group(2), ipa)
    ipa = re.sub(r'([sz])([iÉªÌŸj])', lambda m: 'É•' + m.group(2), ipa)  # s, z åœ¨ i å‰å˜ä¸º É•

    # 6. å¤„ç† /t/, /d/ çš„ç ´æ“¦éŸ³åŒ–
    # /t/ åœ¨ /i/ å‰å˜ä¸º [tÉ•]
    ipa = re.sub(r'tÊ²i', 'tÍ¡É•i', ipa)
    # /d/ åœ¨ /i/ å‰å˜ä¸º [dÊ‘]
    ipa = re.sub(r'dÊ²i', 'dÍ¡Ê‘i', ipa)
    # /t/ åœ¨ /u/ å‰å˜ä¸º [ts]
    ipa = re.sub(r'tÉ¯Ì¹', 'tÍ¡sÉ¯Ì¹', ipa)
    # /d/ åœ¨ /u/ å‰å˜ä¸º [dz]
    ipa = re.sub(r'dÉ¯Ì¹', 'dÍ¡zÉ¯Ì¹', ipa)

    # 7. å¤„ç† /h/ çš„éŸ³å˜
    # /h/ åœ¨ /i/ å‰å˜ä¸º [Ã§]
    ipa = re.sub(r'h([iÉªÌŸ])', r'Ã§\1', ipa)
    # /h/ åœ¨ /u/ å‰å˜ä¸º [É¸]
    ipa = re.sub(r'hÉ¯Ì¹', 'É¸É¯Ì¹', ipa)

    # 8. å¤„ç† /r/ çš„å˜ä½“
    # åœ¨è¯é¦–å’Œ /N/ åï¼Œ/r/ å‘ä¸º [dÌ ÉºÌÌ†]
    ipa = re.sub(r'(^|[É´n])É¾', r'\1dÌ ÉºÌÌ†', ipa)
    # å…¶ä»–ä½ç½®ä¿æŒ [É¾]

    # 9. å¤„ç†å£°é—¨å¡éŸ³çš„æ’å…¥
    # åœ¨å•è¯å¼€å¤´å’Œç»“å°¾æ’å…¥ [Ê”]
    # æ ¹æ®éœ€è¦ï¼Œæ‚¨å¯ä»¥é€‰æ‹©æ˜¯å¦æ’å…¥å£°é—¨å¡éŸ³
    # è¿™é‡Œæˆ‘ä»¬ä¸æ’å…¥å£°é—¨å¡éŸ³ï¼Œä»¥é¿å…å½±å“æ‹¼éŸ³è½¬æ¢
    # å¦‚æœéœ€è¦æ’å…¥ï¼Œå¯ä»¥å–æ¶ˆä»¥ä¸‹æ³¨é‡Š
    # ipa = 'Ê”' + ipa + 'Ê”'

    # 10. å¤„ç† /w/ çš„å‘éŸ³
    # /w/ ä¸º [Î²Ì]ï¼Œå¯è§†æƒ…å†µæ›¿æ¢ä¸º [É°]
    # å¦‚æœéœ€è¦å°† /w/ è¡¨ç¤ºä¸º [É°]ï¼Œå¯å–æ¶ˆä»¥ä¸‹æ³¨é‡Š
    # ipa = ipa.replace('Î²Ì', 'É°')

    return ipa

def ipa_to_pinyin(ipa: str) -> str:
    """
    å°† IPA å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ‹¼éŸ³ã€‚
    """
    ipa_to_pinyin_dict = {
        # Consonants
        'p': 'b', 'pÊ°': 'p', 'm': 'm', 'f': 'f',
        't': 'd', 'tÊ°': 't', 'n': 'n', 'l': 'l',
        'k': 'g', 'kÊ°': 'k', 'x': 'h', 'h': 'h', 'É£': 'e', 'Ï‡': 'h', 'Ê': 'Ê', 'Ä§': 'haÊ°oÊ°', 'Ê•': 'haÊ°o', 'É¦': 'aÊ°',
        'tÉ•': 'j', 'tÉ•Ê°': 'q', 'É•': 'x', 'tÍ¡É•': 'j', 'tÍ¡É•Ê°': 'q',
        'tÊ‚': 'zh', 'tÊ‚Ê°': 'ch', 'Ê‚': 'sh', 'É»': 'r', 'Ê': 'r', 'tÍ¡s': 'z', 'tÍ¡sÊ°': 'c', 'ÊˆÍ¡Ê‚': 'zh', 'ÊˆÍ¡Ê‚Ê°': 'ch',
        'ts': 'z', 'tsÊ°': 'c', 's': 's', 'dÍ¡z': 'zi', 'dz': 'zi',
        'Å‹': 'ng', 'É²': 'ni', 'É²ÌŸ': 'ni',
        'Ê”': 'Ê”',
        'É‰': 'i',
        'w': 'u', 'É¥': 'Ã¼',
        'j': 'i', 'Ã§': 'xi', 'dÍ¡Ê‘': 'ji', 'dÊ‘': 'ji',

        # Syllabic Consonants
        'mÌ©': 'm', 'mÌ¥': 'hm',
        'nÌ©': 'n', 'Å‹Ì': 'ng', 'Å‹ÌŠ': 'hng',
        'É¹Ì©': 'i', 'É»Ì©': 'ri',

        # Vowels
        'i': 'i', 'u': 'u', 'y': 'Ã¼', 'uË': 'ur',
        'ai': 'a', 'Ã¤': 'a', 'É‘': 'ao', 'eÌ': 'ie', 'É™': 'en', 'aÌ ': 'a',
        'o': 'o', 'É”': 'ao', 'oÌ': 'o', 'oÌË': 'or',
        'É¤': 'e', 'É›': 'i', 'e': 'ie', 'Å“': 'ue', 'oÌœ': 'o',
        'Éµ': 'ou', 'ÊŠ': 'ong', 'ÊŠÌƒË': 'ongr', 'É¤Ë': 'e', 'É¤ÌË': 'eng', 'É¤ËË': 'er',
        'Éš': 'r', 'É': 'i', 'ÉšÌƒ': 'ngr', 'ÊŒÌ¹': 'ao',
         'iÌ': 'ie',

        # Diphthongs and Triphthongs
        'ja': 'ia', 'wa': 'ua',
        'jo': 'io', 'wo': 'uo',
        'jÉ›': 'ie', 'É¥É›': 'Ã¼e',
        'aÉª': 'ai', 'waÉª': 'uai', 'aiÌ¯': 'ai',
        'eÉª': 'ei', 'weÉª': 'ui', 'eiÌ¯': 'ei',
        'É‘ÊŠ': 'ao', 'jÉ‘ÊŠ': 'iao', 'É‘uÌ¯': 'ao', 'É‘uÌ¯Ë': 'aor',
        'oÊŠ': 'ou', 'joÊŠ': 'iu', 'ouÌ¯': 'iu', 'ouÌ¯Ë': 'our',

        # R-colored vowels and combinations
        'Ã¤ÉšÌ¯': 'r', 'Ã¤ÌƒÉšÌ¯Ìƒ': 'angr', 'ÉÉšÌ¯': 'yanr',

        'an': 'an', 'jÉ›n': 'ian', 'wan': 'uan', 'É¥Ã¦n': 'Ã¼an',
        'É™n': 'en', 'in': 'in', 'wÉ™n': 'un', 'yn': 'Ã¼n',
        'É‘Å‹': 'ang', 'jÉ‘Å‹': 'iang', 'wÉ‘Å‹': 'uang',
        'É¤Å‹': 'eng', 'iÅ‹': 'ing', 'wÉ¤Å‹': 'ueng',
        'ÊŠÅ‹': 'ong', 'jÊŠÅ‹': 'iong',
        'ÉšÌƒ': 'a',

        # Tones
        'Ë¥Ë¥': '55', 'Ë§Ë¥': '35', 'Ë¨Ë©Ë¦': '214', 'Ë¨Ë©Ë©': '211',
        'Ë©Ë¦': '14', 'Ë¥Ë©': '51', 'Ë¥Ë§': '53',
        'Ë¨Ë©': '21', 'Ë§Ë©': '31', 'Ë¦Ë©': '41', 'Ë©Ë©': '11', 'Ë¨Ë¥': '25',
        'Ë§': '33', 'Ë©Ë§': '13', 'Ë¨Ë§': '23', 'Ë¨': '22',

        # Neutral Tone
        'kË¥': '5', 'kË§': '3', 'kË¨': '2', 'Ë¥': '55',
    }

    # æŒ‰ç…§é”®çš„é•¿åº¦ä»é•¿åˆ°çŸ­æ’åºï¼Œç¡®ä¿æœ€é•¿çš„åŒ¹é…ä¼˜å…ˆ
    ipa_keys = sorted(ipa_to_pinyin_dict.keys(), key=lambda x: -len(x))

    i = 0
    pinyin = ''
    while i < len(ipa):
        matched = False
        for key in ipa_keys:
            if ipa.startswith(key, i):
                pinyin += ipa_to_pinyin_dict[key]
                i += len(key)
                matched = True
                break
        if not matched:
            # å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œä¿ç•™åŸå­—ç¬¦
            pinyin += ipa[i]
            i += 1
    return pinyin

def process_text(text, output_option):
    """
    å¤„ç†è¾“å…¥çš„æ–‡æœ¬ï¼Œè¿”å›è½¬æ¢åçš„ç»“æœã€‚
    """
    result = ''
    # åˆ†å‰²æ–‡æœ¬ï¼Œä¿ç•™ç©ºæ ¼å’Œæ ‡ç‚¹ç¬¦å·
    tokens = re.findall(r'\w+|[^\w\s]', text, re.UNICODE)
    for token in tokens:
        # å¦‚æœæ˜¯ç©ºæ ¼æˆ–æ ‡ç‚¹ç¬¦å·ï¼Œç›´æ¥ä¿ç•™
        if re.match(r'\s', token) or re.match(r'[^\w]', token):
            result += token
        else:
            # ä½¿ç”¨ jumanpp å¯¹å•è¯è¿›è¡Œè§£æ
            jumanpp_output = run_jumanpp(token)
            words = parse_jumanpp_output(jumanpp_output)
            for word in words:
                surface = word['surface']
                reading = word['reading']
                # å¤„ç†åŠ©è¯çš„ç‰¹æ®Šè¯»éŸ³
                if surface == 'ã¯' and reading == 'ã¯':
                    reading = 'ã‚'
                elif surface == 'ã¸' and reading == 'ã¸':
                    reading = 'ãˆ'
                elif surface == 'ã‚’' and reading == 'ã‚’':
                    reading = 'ãŠ'
                ipa = kana_to_ipa(reading)
                ipa = apply_phonological_rules(ipa)
                if output_option == '1':
                    result += f"\\anno{{{surface}}}{{{ipa}}}"
                elif output_option == '2':
                    pinyin = ipa_to_pinyin(ipa)
                    result += f"\\anno{{{surface}}}{{{pinyin}}}"
                else:
                    result += f"\\anno{{{surface}}}{{{ipa}}}"
    return result

def main():
    # æ·»åŠ æ¨¡å¼é€‰æ‹©
    mode = input("è¯·é€‰æ‹©æ¨¡å¼ï¼ˆ1: äº¤äº’æ¨¡å¼ï¼Œ2: æ–‡ä»¶æ¨¡å¼ï¼‰ï¼š")
    if mode == '1':
        sentence = input("è¯·è¾“å…¥æ—¥è¯­å¥å­ï¼š")
        output_option = input("è¯·é€‰æ‹©è¾“å‡ºç±»å‹ï¼ˆ1: IPAï¼Œ2: æ‹¼éŸ³ï¼‰ï¼š")
        result = process_text(sentence, output_option)
        print(result.strip())
    elif mode == '2':
        # æ–‡ä»¶æ¨¡å¼
        if not os.path.exists('input.txt'):
            print("æœªæ‰¾åˆ° input.txt æ–‡ä»¶ã€‚")
            return
        with open('input.txt', 'r', encoding='utf-8') as f:
            text = f.read()
        output_option = input("è¯·é€‰æ‹©è¾“å‡ºç±»å‹ï¼ˆ1: IPAï¼Œ2: æ‹¼éŸ³ï¼‰ï¼š")
        # å¤„ç†æ–‡æœ¬ä¸­çš„æ¢è¡Œç¬¦ï¼Œæ›¿æ¢ä¸º '\\'
        text = text.replace('\n', '\\\\')
        result = process_text(text, output_option)
        # å°†ç»“æœå†™å…¥ output.txt
        with open('output.txt', 'w', encoding='utf-8') as f:
            f.write(result)
        print("è½¬æ¢å®Œæˆï¼Œç»“æœå·²å†™å…¥ output.txtã€‚")
    else:
        print("æ— æ•ˆçš„æ¨¡å¼é€‰æ‹©ã€‚")

if __name__ == "__main__":
    main()